{% extends 'base.html' %}
{% block content %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<div class="h-[calc(100vh-100px)] flex gap-6 animate__animated animate__fadeIn">
    
    <div class="w-80 flex-shrink-0 flex flex-col gap-6">
        
        <button onclick="abrirModalCrear()" class="bg-[#2D1B4B] text-white p-4 rounded-2xl shadow-lg hover:bg-[#A855F7] transition-all flex items-center justify-center gap-3 w-full group">
            <div class="bg-[#A855F7] w-8 h-8 rounded-full flex items-center justify-center text-white group-hover:scale-110 transition-transform">
                <i class="fas fa-plus"></i>
            </div>
            <span class="font-bold tracking-widest text-sm">AGENDAR EVENTO</span>
        </button>

        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex-1 overflow-y-auto custom-scrollbar">
            <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <i class="fas fa-gavel text-red-500"></i> PrÃ³ximas Audiencias
            </h3>
            
            <div class="space-y-4">
                {% for aud in proximas_audiencias %}
                <div class="relative pl-4 border-l-2 border-red-500">
                    <p class="text-xs font-bold text-red-500 mb-1">{{ aud.inicio|date:"d M - H:i" }}</p>
                    <p class="text-sm font-black text-[#2D1B4B] leading-tight">{{ aud.titulo }}</p>
                    <p class="text-[10px] text-gray-400 mt-1">{{ aud.cliente.nombre_empresa }}</p>
                </div>
                {% empty %}
                <p class="text-xs text-gray-300 italic">No hay audiencias prÃ³ximas.</p>
                {% endfor %}
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100">
                <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Leyenda</h3>
                <div class="space-y-2 text-xs font-bold text-gray-500">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div> Audiencia</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div> Vencimiento</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-500"></div> ReuniÃ³n</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-emerald-500"></div> TrÃ¡mite</div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 relative overflow-hidden">
        <div id='calendar' class="h-full font-sans text-sm"></div>
    </div>

</div>

<div id="modal-evento" class="fixed inset-0 bg-[#2D1B4B]/90 hidden items-center justify-center z-50 backdrop-blur-sm animate__animated animate__fadeIn">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-md m-4 shadow-2xl relative animate__animated animate__zoomIn">
        <button onclick="document.getElementById('modal-evento').classList.add('hidden')" class="absolute top-6 right-6 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
        
        <h3 class="text-2xl font-black text-[#2D1B4B] mb-1">Nuevo Evento</h3>
        <p class="text-xs text-gray-400 mb-6 uppercase tracking-widest">Agenda Inteligente</p>
        
        <form action="{% url 'crear_evento' %}" method="POST" class="space-y-4">
            {% csrf_token %}
            
            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">TÃ­tulo</label>
                <input type="text" name="titulo" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border-none outline-none focus:ring-2 focus:ring-[#A855F7]" placeholder="Ej. Audiencia Inicial..." required>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Fecha</label>
                    <input type="date" name="fecha" id="input-fecha" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border-none outline-none" required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Hora</label>
                    <input type="time" name="hora" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border-none outline-none" required>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Tipo</label>
                    <select name="tipo" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border-none outline-none">
                        <option value="audiencia">ðŸ”´ Audiencia</option>
                        <option value="vencimiento">ðŸŸ  Vencimiento</option>
                        <option value="reunion" selected>ðŸ”µ ReuniÃ³n</option>
                        <option value="tramite">ðŸŸ¢ TrÃ¡mite</option>
                        <option value="personal">âšª Personal</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Cliente</label>
                    <select name="cliente_id" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border-none outline-none">
                        <option value="">-- Personal --</option>
                        {% for c in clientes %}
                        <option value="{{ c.id }}">{{ c.nombre_empresa }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Notas Adicionales</label>
                <textarea name="descripcion" rows="2" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border-none outline-none resize-none"></textarea>
            </div>

            <button type="submit" class="w-full bg-[#2D1B4B] text-white py-4 rounded-xl font-bold hover:bg-[#A855F7] shadow-lg transition-all mt-2">
                AGENDAR AHORA
            </button>
        </form>
    </div>
</div>

<div id="modal-detalle" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm animate__animated animate__fadeIn">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-sm m-4 shadow-2xl relative">
        <button onclick="document.getElementById('modal-detalle').classList.add('hidden')" class="absolute top-6 right-6 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        
        <div id="detalle-header" class="mb-4 border-l-4 border-gray-300 pl-4">
            <p id="det-tipo" class="text-[10px] font-black uppercase tracking-widest text-gray-400">TIPO</p>
            <h3 id="det-titulo" class="text-xl font-black text-[#2D1B4B]">TÃ­tulo</h3>
        </div>

        <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3 text-sm text-gray-600">
                <i class="fas fa-clock w-5 text-center"></i>
                <span id="det-fecha" class="font-bold">Fecha y Hora</span>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600">
                <i class="fas fa-briefcase w-5 text-center"></i>
                <span id="det-cliente" class="font-bold">Cliente</span>
            </div>
            <div class="bg-gray-50 p-3 rounded-xl text-xs text-gray-500 italic mt-2" id="det-desc">
                Sin descripciÃ³n.
            </div>
        </div>

        <button id="btn-eliminar" class="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold hover:bg-red-100 transition-all border border-red-100 flex items-center justify-center gap-2">
            <i class="fas fa-trash"></i> Eliminar Evento
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'DÃ­a'
            },
            events: '/agenda/api/', // API DE DJANGO
            editable: true, // DRAG & DROP ACTIVADO
            selectable: true,
            
            // AcciÃ³n: Clic en dÃ­a vacÃ­o -> Crear
            dateClick: function(info) {
                document.getElementById('input-fecha').value = info.dateStr;
                abrirModalCrear();
            },

            // AcciÃ³n: Clic en evento -> Ver Detalle
            eventClick: function(info) {
                mostrarDetalle(info.event);
            },

            // AcciÃ³n: Arrastrar y Soltar -> Guardar en BD
            eventDrop: function(info) {
                actualizarFecha(info.event);
            }
        });
        calendar.render();
    });

    function abrirModalCrear() {
        document.getElementById('modal-evento').classList.remove('hidden');
        document.getElementById('modal-evento').classList.add('flex');
    }

    function mostrarDetalle(event) {
        document.getElementById('det-titulo').innerText = event.title;
        document.getElementById('det-fecha').innerText = event.start.toLocaleString();
        document.getElementById('det-cliente').innerText = event.extendedProps.cliente;
        document.getElementById('det-tipo').innerText = event.extendedProps.tipo.toUpperCase();
        document.getElementById('det-desc').innerText = event.extendedProps.descripcion || "Sin notas adicionales.";
        
        // Configurar botÃ³n eliminar
        const btn = document.getElementById('btn-eliminar');
        btn.onclick = function() {
            if(confirm('Â¿Eliminar este evento?')) {
                fetch(`/agenda/eliminar/${event.id}/`)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'ok') {
                        event.remove();
                        document.getElementById('modal-detalle').classList.add('hidden');
                    } else {
                        alert("No tienes permiso para eliminar este evento.");
                    }
                });
            }
        };

        document.getElementById('modal-detalle').classList.remove('hidden');
        document.getElementById('modal-detalle').classList.add('flex');
    }

    function actualizarFecha(event) {
        fetch('/agenda/mover/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                id: event.id,
                start: event.start.toISOString(),
                end: event.end ? event.end.toISOString() : null
            })
        }).then(res => res.json()).then(data => {
            if(data.status !== 'ok') {
                alert("Error al mover: " + data.msg);
                event.revert(); // Regresar a posiciÃ³n original si falla
            }
        });
    }
</script>

<style>
    /* PersonalizaciÃ³n FullCalendar estilo Corpad Morado */
    .fc-toolbar-title { font-family: 'Playfair Display', serif; font-weight: 900; color: #2D1B4B; }
    .fc-button-primary { background-color: #2D1B4B !important; border-color: #2D1B4B !important; font-weight: bold; border-radius: 0.5rem !important; }
    .fc-button-primary:hover { background-color: #A855F7 !important; border-color: #A855F7 !important; }
    .fc-daygrid-day-number { color: #2D1B4B; font-weight: bold; }
    .fc-col-header-cell-cushion { color: #A855F7; font-weight: 900; text-transform: uppercase; font-size: 0.75rem; }
    .fc-event { border: none; border-radius: 4px; font-size: 0.75rem; font-weight: bold; padding: 2px; cursor: pointer; transition: transform 0.1s; }
    .fc-event:hover { transform: scale(1.02); }
    .fc-day-today { background-color: #F3F4F6 !important; }
</style>
{% endblock %}