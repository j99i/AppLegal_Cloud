{% extends 'base.html' %}
{% block content %}
<div class="animate__animated animate__fadeIn pb-20 p-4">
    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-6">
            <div class="w-20 h-20 bg-slate-50 rounded-3xl border flex items-center justify-center">
                {% if cliente.logo %}<img src="{{ cliente.logo.url }}" class="p-2">{% else %}<i class="fas fa-building text-3xl text-gray-200"></i>{% endif %}
            </div>
            <div>
                <h2 class="text-3xl font-black text-[#1A2238]">{{ cliente.nombre_empresa }}</h2>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Panel de Control Legal</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="openModal('modal-carpeta')" class="bg-white border-2 border-[#1A2238] text-[#1A2238] px-6 py-3 rounded-2xl font-black text-xs">+ CARPETA</button>
            <button onclick="openModal('modal-expediente')" class="bg-[#1A2238] text-white px-6 py-3 rounded-2xl font-black text-xs shadow-lg">+ EXPEDIENTE</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-3 bg-white rounded-[2.5rem] p-8 shadow-sm border">
            <div class="flex justify-between items-center mb-10">
                <h3 class="text-xl font-black text-[#1A2238] italic underline decoration-amber-400">LEGAL DRIVE</h3>
                <button onclick="openModal('modal-subir')" class="bg-[#C0A062] text-white px-5 py-2 rounded-xl text-[10px] font-black uppercase"><i class="fas fa-upload mr-2"></i> CARGAR</button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
                {% for c in carpetas %}
                <div class="group p-6 bg-slate-50 rounded-[2rem] border-2 border-transparent hover:border-amber-400 hover:bg-white transition-all text-center">
                    <i class="fas {% if c.es_expediente %}fa-folder-open text-blue-500{% else %}fa-folder text-amber-400{% endif %} text-5xl mb-3"></i>
                    <p class="text-[11px] font-black text-[#1A2238] uppercase truncate">{{ c.nombre }}</p>
                </div>
                {% empty %}
                <p class="col-span-full text-center text-gray-300 font-bold py-10">No hay carpetas creadas aún.</p>
                {% endfor %}
            </div>

            <div class="space-y-3">
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Documentos en la Raíz</h4>
                {% for doc in cliente.todos_documentos.all %}
                {% if not doc.carpeta %}
                <div class="flex items-center justify-between p-4 bg-white border border-gray-100 rounded-2xl group hover:shadow-md transition-all">
                    <div class="flex items-center gap-4">
                        <i class="far fa-file-alt text-[#C0A062] text-xl"></i>
                        <div>
                            <p class="text-sm font-bold text-[#1A2238]">{{ doc.nombre_archivo }}</p>
                            <p class="text-[9px] text-gray-400 font-black uppercase">{{ doc.fecha_subida|date:"d M Y" }}</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="abrirVisor('{{ doc.archivo.url }}')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-eye"></i></button>
                        <a href="{% url 'eliminar_archivo' doc.id %}" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash"></i></a>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="space-y-8">
            <div class="bg-[#1A2238] p-8 rounded-[2.5rem] shadow-xl text-white">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-black italic">AGENDA</h3>
                    <button onclick="openModal('modal-tarea')" class="text-[10px] bg-[#C0A062] px-3 py-1 rounded-lg"> NUEVO</button>
                </div>
                <div class="space-y-4">
                    {% for t in tareas %}
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/5">
                        <p class="text-sm font-bold">{{ t.titulo }}</p>
                        <p class="text-[10px] text-[#C0A062] font-black uppercase mt-1">Vence: {{ t.fecha_limite }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-[2.5rem] border">
                <h3 class="text-xs font-black text-gray-400 uppercase mb-4">Bitácora</h3>
                <div class="space-y-3">
                    {% for log in bitacora_cliente %}
                    <div class="text-[10px] border-b pb-2">
                        <span class="font-black text-[#1A2238]">{{ log.usuario.username }}</span> {{ log.descripcion }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-carpeta" class="fixed inset-0 bg-[#1A2238]/90 hidden items-center justify-center z-[200]">
    <div class="bg-white p-10 rounded-[3rem] max-w-md w-full">
        <h3 class="text-2xl font-black mb-6">Nueva Carpeta</h3>
        <form action="{% url 'crear_carpeta' cliente.id %}" method="POST" class="space-y-4">
            {% csrf_token %}
            <input type="text" name="nombre" placeholder="Nombre (ej. Contratos)" class="w-full p-4 bg-gray-50 rounded-2xl" required>
            <button type="submit" class="w-full py-4 bg-[#C0A062] text-white rounded-2xl font-black">CREAR</button>
            <button type="button" onclick="closeModal('modal-carpeta')" class="w-full text-gray-400 font-bold mt-2">Cerrar</button>
        </form>
    </div>
</div>

<div id="modal-expediente" class="fixed inset-0 bg-[#1A2238]/90 hidden items-center justify-center z-[200]">
    <div class="bg-white p-10 rounded-[3rem] max-w-md w-full">
        <h3 class="text-2xl font-black mb-6">Nuevo Expediente</h3>
        <form action="{% url 'crear_expediente' cliente.id %}" method="POST" class="space-y-4">
            {% csrf_token %}
            <input type="text" name="num_expediente" placeholder="Num. Expediente" class="w-full p-4 bg-gray-50 rounded-2xl" required>
            <input type="text" name="titulo" placeholder="Título del Caso" class="w-full p-4 bg-gray-50 rounded-2xl" required>
            <button type="submit" class="w-full py-4 bg-[#1A2238] text-white rounded-2xl font-black">CREAR Y VINCULAR</button>
            <button type="button" onclick="closeModal('modal-expediente')" class="w-full text-gray-400 font-bold mt-2">Cerrar</button>
        </form>
    </div>
</div>

<div id="modal-subir" class="fixed inset-0 bg-[#1A2238]/90 hidden items-center justify-center z-[200]">
    <div class="bg-white p-10 rounded-[3rem] max-w-md w-full">
        <h3 class="text-2xl font-black mb-6">Subir Archivo</h3>
        <form action="{% url 'subir_archivo_drive' cliente.id %}" method="POST" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <select name="carpeta_id" class="w-full p-4 bg-gray-50 rounded-2xl">
                <option value="">Carpeta Raíz</option>
                {% for c in carpetas %}<option value="{{ c.id }}">{{ c.nombre }}</option>{% endfor %}
            </select>
            <input type="file" name="archivo" class="w-full p-4 bg-gray-50 rounded-2xl" required>
            <button type="submit" class="w-full py-4 bg-[#C0A062] text-white rounded-2xl font-black">SUBIR AHORA</button>
            <button type="button" onclick="closeModal('modal-subir')" class="w-full text-gray-400 font-bold mt-2">Cerrar</button>
        </form>
    </div>
</div>

<script>
    function openModal(id) { document.getElementById(id).classList.replace('hidden', 'flex'); }
    function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
    function abrirVisor(url) { /* Lógica de visor que ya tenías */ }
</script>
{% endblock %}