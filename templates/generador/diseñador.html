{% extends 'base.html' %}
{% block content %}
<div class="max-w-7xl mx-auto h-[calc(100vh-100px)] flex flex-col animate__animated animate__fadeIn">
    
    <div class="flex justify-between items-center mb-4">
        <div>
            <h2 class="text-2xl font-black text-[#2D1B4B]">Diseñador de Plantillas</h2>
            <p class="text-sm text-gray-500">Selecciona texto y asígnalo a una variable del glosario o crea una nueva.</p>
        </div>
        <div class="flex gap-3">
            <input type="text" id="nombre-plantilla" placeholder="Nombre de la Plantilla Final" class="border-2 border-gray-300 p-2 rounded-xl text-sm font-bold w-64 focus:border-[#A855F7] outline-none text-[#2D1B4B]">
            <button onclick="guardarPlantilla()" class="bg-[#2D1B4B] text-white px-6 py-2 rounded-xl font-bold text-xs shadow-lg hover:bg-[#A855F7] transition-colors">
                <i class="fas fa-save mr-2"></i> GUARDAR MAESTRA
            </button>
        </div>
    </div>

    <div class="flex-1 flex gap-6 overflow-hidden">
        
        <div class="flex-1 bg-white rounded-[2rem] shadow-xl border border-gray-200 flex flex-col relative overflow-hidden">
            <div id="drop-zone" class="absolute inset-0 bg-gray-50 z-20 flex flex-col items-center justify-center border-4 border-dashed border-gray-300 m-4 rounded-3xl hover:bg-purple-50 hover:border-purple-300 transition-colors cursor-pointer" onclick="document.getElementById('input-word-upload').click()">
                <i class="fas fa-file-word text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-500">Sube tu documento "Ejemplo" aquí</h3>
                <p class="text-sm text-gray-400">Puede tener datos reales (Ej. Juan Pérez).</p>
                <input type="file" id="input-word-upload" accept=".docx" class="hidden" onchange="cargarDocumento(this)">
            </div>
            
            <div id="editor-canvas" class="flex-1 overflow-y-auto p-12 custom-scrollbar text-justify prose max-w-none hidden" onmouseup="detectarSeleccion()"></div>
        </div>

        <div class="w-80 bg-white rounded-[2rem] shadow-lg border border-gray-100 flex flex-col">
            <div class="p-5 bg-[#2D1B4B] text-white rounded-t-[2rem]">
                <h3 class="font-bold text-sm"><i class="fas fa-list-ul mr-2 text-[#A855F7]"></i> Reemplazos Activos</h3>
            </div>
            <div id="lista-reemplazos" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <p class="text-xs text-center text-gray-400 mt-10">Selecciona texto para comenzar.</p>
            </div>
        </div>
    </div>
</div>

<div id="popup-variable" class="fixed hidden bg-white shadow-2xl rounded-2xl border border-gray-200 z-50 w-80 animate__animated animate__zoomIn overflow-hidden font-sans">
    
    <div id="popup-header" class="bg-gray-50 p-4 border-b border-gray-100 cursor-move select-none active:bg-gray-100 transition-colors">
        <div class="flex justify-between items-center mb-1">
            <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Texto Seleccionado</h4>
            <i class="fas fa-arrows-alt text-gray-300 text-xs"></i>
        </div>
        <p id="texto-seleccionado" class="text-sm font-bold text-[#2D1B4B] truncate bg-white p-2 rounded border border-gray-200 select-text">...</p>
    </div>

    <div class="flex border-b border-gray-200">
        <button onclick="cambiarTab('existente')" id="tab-existente" class="flex-1 py-3 text-xs font-bold text-[#2D1B4B] border-b-2 border-[#2D1B4B] bg-white">Existente</button>
        <button onclick="cambiarTab('nueva')" id="tab-nueva" class="flex-1 py-3 text-xs font-bold text-gray-400 bg-gray-50 hover:bg-gray-100">Crear Nueva</button>
    </div>

    <div class="p-4">
        <div id="panel-existente">
            <label class="text-[10px] font-bold text-gray-500 mb-1 block">BUSCAR EN GLOSARIO:</label>
            
            <div class="relative mb-2">
                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                <input type="text" id="filtro-glosario" placeholder="Filtrar variables..." class="w-full pl-8 p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm font-bold text-[#2D1B4B] focus:border-[#A855F7] outline-none">
            </div>

            <select id="select-glosario" size="5" class="w-full p-2 bg-white rounded-lg border border-gray-200 text-xs mb-4 text-[#2D1B4B] focus:border-[#A855F7] outline-none custom-scrollbar shadow-inner">
                {% for v in glosario %}
                <option value="{{ v.clave }}" class="p-2 border-b border-gray-50 hover:bg-purple-50 cursor-pointer rounded">{{ v.descripcion }} ({{ v.clave }})</option>
                {% endfor %}
            </select>

            <button onclick="confirmarReemplazo('existente')" class="w-full py-3 bg-[#2D1B4B] rounded-xl text-xs font-bold text-white hover:bg-opacity-90 shadow-lg">APLICAR VARIABLE</button>
        </div>

        <div id="panel-nueva" class="hidden space-y-3">
            <div>
                <label class="text-[10px] font-bold text-gray-500 block mb-1">NOMBRE CLAVE (Sin espacios)</label>
                <input type="text" id="nueva-clave" placeholder="Ej. nombre_aval" class="w-full p-2 bg-white border-2 border-gray-200 rounded-lg text-sm font-bold text-[#2D1B4B] focus:border-[#A855F7] outline-none">
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-500 block mb-1">DESCRIPCIÓN (Para el usuario)</label>
                <input type="text" id="nueva-desc" placeholder="Ej. Nombre Completo del Aval" class="w-full p-2 bg-white border-2 border-gray-200 rounded-lg text-sm text-gray-600 focus:border-[#A855F7] outline-none">
            </div>
            <button onclick="crearYAsignar()" id="btn-crear" class="w-full py-3 bg-[#A855F7] rounded-xl text-xs font-bold text-white hover:bg-[#9333ea] shadow-lg flex justify-center items-center">
                <span>GUARDAR Y APLICAR</span>
            </button>
        </div>

        <button onclick="cancelarSeleccion()" class="w-full mt-3 py-2 text-xs font-bold text-gray-400 hover:text-red-400">Cancelar</button>
    </div>
</div>

<form id="form-final" method="POST" enctype="multipart/form-data" class="hidden">
    {% csrf_token %}
    <input type="text" name="nombre" id="input-nombre-final">
    <input type="file" name="archivo_base" id="input-archivo-final">
    <input type="hidden" name="reemplazos" id="input-reemplazos-final">
</form>

<script>
    let archivoActual=null, listaReemplazos=[], seleccionActual=null;
    const LLAVE_ABRE='\u007B\u007B', LLAVE_CIERRA='\u007D\u007D';

    // Lógica de Pestañas
    function cambiarTab(modo) {
        document.getElementById('panel-existente').classList.toggle('hidden', modo !== 'existente');
        document.getElementById('panel-nueva').classList.toggle('hidden', modo !== 'nueva');
        
        const tabEx = document.getElementById('tab-existente');
        const tabNu = document.getElementById('tab-nueva');
        if(modo === 'existente'){
            tabEx.className = "flex-1 py-3 text-xs font-bold text-[#2D1B4B] border-b-2 border-[#2D1B4B] bg-white";
            tabNu.className = "flex-1 py-3 text-xs font-bold text-gray-400 bg-gray-50 hover:bg-gray-100";
            // Enfocar buscador al cambiar
            setTimeout(() => document.getElementById('filtro-glosario').focus(), 100);
        } else {
            tabNu.className = "flex-1 py-3 text-xs font-bold text-[#A855F7] border-b-2 border-[#A855F7] bg-white";
            tabEx.className = "flex-1 py-3 text-xs font-bold text-gray-400 bg-gray-50 hover:bg-gray-100";
        }
    }

    // ==========================================
    // NUEVA LÓGICA: FILTRADO DE VARIABLES
    // ==========================================
    document.getElementById('filtro-glosario').addEventListener('input', function(e) {
        const busqueda = e.target.value.toLowerCase();
        const opciones = document.getElementById('select-glosario').options;
        let found = false;
        
        for (let i = 0; i < opciones.length; i++) {
            const texto = opciones[i].text.toLowerCase();
            if (texto.includes(busqueda)) {
                opciones[i].style.display = ""; // Mostrar
                if (!found && busqueda.length > 0) {
                    opciones[i].selected = true; // Auto-seleccionar primer match
                    found = true;
                }
            } else {
                opciones[i].style.display = "none"; // Ocultar
            }
        }
    });

    // Permitir aplicar con Enter desde el buscador
    document.getElementById('filtro-glosario').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            confirmarReemplazo('existente');
        }
    });

    async function cargarDocumento(input) {
        if (input.files && input.files[0]) {
            archivoActual = input.files[0];
            document.getElementById('drop-zone').innerHTML = '<i class="fas fa-spinner fa-spin text-4xl text-[#A855F7]"></i><p class="mt-4 text-gray-500 font-bold">Procesando Word...</p>';
            
            const formData = new FormData(); 
            formData.append('archivo', archivoActual);
            
            try {
                const res = await fetch("{% url 'previsualizar_word_raw' %}", { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.html){
                    document.getElementById('editor-canvas').innerHTML = data.html;
                    document.getElementById('editor-canvas').classList.remove('hidden');
                    document.getElementById('drop-zone').classList.add('hidden');
                } else {
                    alert("Error: No se pudo leer el contenido del Word.");
                    location.reload(); 
                }
            } catch(e) { 
                console.error(e);
                alert("Error al cargar el documento. Verifica tu conexión.");
                location.reload();
            }
        }
    }

    function detectarSeleccion() {
        const sel = window.getSelection(); 
        const text = sel.toString().trim();
        
        if (text.length > 0 && !document.getElementById('popup-variable').contains(sel.anchorNode)) {
            seleccionActual = text;
            const range = sel.getRangeAt(0); 
            const rect = range.getBoundingClientRect();
            const popup = document.getElementById('popup-variable');
            document.getElementById('texto-seleccionado').innerText = text;
            
            let top = rect.bottom + window.scrollY + 10;
            let left = rect.left + window.scrollX;
            if(left + 320 > window.innerWidth) left = window.innerWidth - 340; 
            
            popup.style.top = top + 'px'; 
            popup.style.left = left + 'px';
            
            popup.classList.remove('hidden');
            popup.classList.add('animate__zoomIn');
            
            // Limpiar filtro anterior
            document.getElementById('filtro-glosario').value = '';
            const opts = document.getElementById('select-glosario').options;
            for(let i=0; i<opts.length; i++) opts[i].style.display = "";
            
            cambiarTab('existente'); 
        }
    }

    function cancelarSeleccion() {
        document.getElementById('popup-variable').classList.add('hidden');
        window.getSelection().removeAllRanges();
    }

    function aplicarCambioVisual(variable) {
        listaReemplazos.push({ texto_original: seleccionActual, variable: variable });
        actualizarListaVisual();
        const editor = document.getElementById('editor-canvas');
        const etiqueta = `<span class="bg-yellow-200 border-b-2 border-[#A855F7] px-1 font-mono text-xs text-black">${LLAVE_ABRE} ${variable} ${LLAVE_CIERRA}</span>`;
        editor.innerHTML = editor.innerHTML.replace(seleccionActual, etiqueta);
        cancelarSeleccion();
    }

    function confirmarReemplazo() {
        const variable = document.getElementById('select-glosario').value;
        if (!variable) return alert("Selecciona una variable");
        aplicarCambioVisual(variable);
    }

    async function crearYAsignar() {
        const clave = document.getElementById('nueva-clave').value;
        const desc = document.getElementById('nueva-desc').value;
        const btn = document.getElementById('btn-crear');
        
        if(!clave || !desc) return alert("Llena ambos campos");
        
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;

        try {
            const response = await fetch("{% url 'api_crear_variable' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ clave: clave, descripcion: desc })
            });
            const data = await response.json();
            
            if(data.status === 'ok') {
                const select = document.getElementById('select-glosario');
                const option = document.createElement('option');
                option.value = data.clave || clave; 
                option.text = `${desc} (${data.clave || clave})`;
                select.add(option);
                
                aplicarCambioVisual(data.clave || clave);
                document.getElementById('nueva-clave').value = '';
                document.getElementById('nueva-desc').value = '';
            } else {
                alert("Error: " + (data.msg || "No se pudo crear"));
            }
        } catch(e) {
            alert("Error de conexión");
        } finally {
            btn.innerHTML = textoOriginal;
            btn.disabled = false;
        }
    }

    function actualizarListaVisual() {
        const cont = document.getElementById('lista-reemplazos'); cont.innerHTML = '';
        listaReemplazos.forEach((item, i) => {
            cont.innerHTML += `<div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center group animate__animated animate__fadeIn"><div class="truncate mr-2"><p class="text-[10px] text-gray-400 line-through truncate">${item.texto_original}</p><p class="text-xs font-black text-[#2D1B4B]">${LLAVE_ABRE} ${item.variable} ${LLAVE_CIERRA}</p></div><button onclick="eliminarReemplazo(${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></div>`;
        });
    }
    
    function eliminarReemplazo(i){ listaReemplazos.splice(i, 1); actualizarListaVisual(); }
    
    function guardarPlantilla() {
        const nombre = document.getElementById('nombre-plantilla').value;
        if (!nombre || !archivoActual || listaReemplazos.length === 0) return alert("Faltan datos: Asegúrate de subir un archivo, hacer reemplazos y poner un nombre.");
        
        document.getElementById('input-nombre-final').value = nombre;
        
        const dt = new DataTransfer(); 
        dt.items.add(archivoActual);
        document.getElementById('input-archivo-final').files = dt.files;
        
        document.getElementById('input-reemplazos-final').value = JSON.stringify(listaReemplazos);
        document.getElementById('form-final').submit();
    }

    // DRAGGABLE LOGIC
    document.addEventListener('DOMContentLoaded', () => {
        const popup = document.getElementById('popup-variable');
        const header = document.getElementById('popup-header');
        let isDragging = false, dragOffsetX = 0, dragOffsetY = 0;

        header.addEventListener('mousedown', (e) => {
            isDragging = true;
            const rect = popup.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            header.style.cursor = 'grabbing';
            popup.classList.remove('animate__zoomIn'); 
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                e.preventDefault();
                popup.style.left = `${e.clientX - dragOffsetX}px`;
                popup.style.top = `${e.clientY - dragOffsetY}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            if(isDragging) { isDragging = false; header.style.cursor = 'move'; }
        });
    });
</script>
{% endblock %}