{% extends 'base.html' %}
{% load custom_filters %} 

{% block content %}
<div class="max-w-7xl mx-auto animate__animated animate__fadeIn">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
        <div>
            <h2 class="text-4xl font-black text-[#2D1B4B]">Panel Financiero</h2>
            <p class="text-gray-500 font-bold mt-1">
                <i class="fas fa-calendar-alt mr-1"></i> {{ now|date:"d M Y" }}
            </p>
        </div>
        
        <div class="flex gap-4">
            <button onclick="document.getElementById('modal-nueva-cotizacion').classList.remove('hidden'); document.getElementById('modal-nueva-cotizacion').classList.add('flex');" class="bg-[#2D1B4B] text-white px-5 py-3 rounded-2xl text-sm font-bold shadow-lg hover:bg-[#A855F7] transition-all flex items-center gap-2 transform hover:-translate-y-1">
                <i class="fas fa-plus"></i> Nuevo Proyecto
            </button>

            {% if user.rol == 'admin' %}
            <button onclick="abrirModalEmisor()" class="bg-white border border-gray-200 text-gray-600 px-5 py-3 rounded-2xl text-sm font-bold shadow-sm hover:bg-gray-50 transition-all flex items-center gap-2">
                <i class="fas fa-cog"></i> Fiscal
            </button>
            {% endif %}

            <a href="{% url 'libro_contable' %}" class="bg-white border border-gray-200 text-[#2D1B4B] px-5 py-3 rounded-2xl font-bold shadow-sm hover:bg-gray-50 transition-all flex items-center gap-2">
                <i class="fas fa-book"></i> Libro
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
        <div class="bg-gradient-to-br from-[#2D1B4B] to-[#432C68] p-8 rounded-[2.5rem] shadow-xl text-white relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl group-hover:bg-white/10 transition-all"></div>
            <p class="text-sm font-bold opacity-60 uppercase tracking-wider mb-2">Por Cobrar Global</p>
            <p class="text-4xl font-black tracking-tight">${{ total_por_cobrar|floatformat:2 }}</p>
            <div class="mt-6 flex items-center text-xs font-bold opacity-80 bg-white/10 w-fit px-3 py-1 rounded-full">
                <i class="fas fa-arrow-up mr-2 text-green-400"></i> Actualizado hoy
            </div>
        </div>
        </div>

    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100">
        <h3 class="text-xl font-black text-[#2D1B4B] mb-8 flex items-center gap-3">
            <span class="w-2 h-8 bg-[#A855F7] rounded-full"></span>
            Cartera de Clientes
        </h3>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs text-gray-400 border-b border-gray-100">
                        <th class="py-4 pl-4 font-bold uppercase tracking-wider">Cliente</th>
                        <th class="py-4 font-bold uppercase tracking-wider text-center">Proyectos Activos</th>
                        <th class="py-4 font-bold uppercase tracking-wider text-right">Pagado</th>
                        <th class="py-4 font-bold uppercase tracking-wider text-right">Deuda</th>
                        <th class="py-4 font-bold uppercase tracking-wider text-right pr-4">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    {% for c in clientes %}
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors group">
                        <td class="py-5 pl-4">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center font-bold text-gray-400">
                                    {{ c.nombre_empresa|slice:":1" }}
                                </div>
                                <div>
                                    <p class="font-bold text-[#2D1B4B] text-base">{{ c.nombre_empresa }}</p>
                                    <p class="text-xs text-gray-400">{{ c.rfc|default:"Sin RFC" }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-5 text-center font-bold text-gray-600">
                            <span class="bg-gray-100 px-3 py-1 rounded-lg">{{ c.total_proyectos }}</span>
                        </td>
                        <td class="py-5 text-right font-bold text-green-600">
                            ${{ c.pagado_total|floatformat:2 }}
                        </td>
                        <td class="py-5 text-right font-bold text-red-500 text-base">
                            ${{ c.deuda_total|floatformat:2 }}
                        </td>
                        <td class="py-5 text-right pr-4">
                            <a href="{% url 'finanzas_cliente_detalle' c.id %}" class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-[#2D1B4B] text-white hover:bg-[#A855F7] shadow-md transition-all">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-10 text-gray-400 italic">No hay actividad financiera registrada.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<div id="modal-nueva-cotizacion" class="fixed inset-0 bg-[#2D1B4B]/90 hidden items-center justify-center z-50">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl relative m-4 animate__animated animate__zoomIn">
        <button onclick="document.getElementById('modal-nueva-cotizacion').classList.add('hidden'); document.getElementById('modal-nueva-cotizacion').classList.remove('flex');" class="absolute top-5 right-5 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
        
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-green-600 text-2xl">
                <i class="fas fa-file-signature"></i>
            </div>
            <h3 class="text-2xl font-black text-[#2D1B4B]">Nueva Cotización</h3>
            <p class="text-sm text-gray-500">Inicia un nuevo proyecto legal.</p>
        </div>
        
        <form action="{% url 'nueva_cotizacion' %}" method="POST" class="space-y-4">
            {% csrf_token %}
            
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Cliente</label>
                <select name="cliente" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border border-gray-100 outline-none focus:border-[#A855F7]" required>
                    <option value="" disabled selected>Seleccionar Cliente...</option>
                    {% for c in clientes %}
                        <option value="{{ c.id }}">{{ c.nombre_empresa }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Nombre del Proyecto</label>
                <input type="text" name="titulo_proyecto" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border border-gray-100 outline-none focus:border-[#A855F7]" placeholder="Ej: Divorcio Express, Contrato Mercantil..." required autocomplete="off">
            </div>

            <button type="submit" class="w-full bg-[#2D1B4B] text-white py-4 rounded-xl font-bold shadow-lg hover:bg-[#A855F7] transition-all transform hover:-translate-y-1 mt-2">
                CREAR PROYECTO
            </button>
        </form>
    </div>
</div>

<div id="modal-emisor" class="fixed inset-0 bg-[#2D1B4B]/90 hidden items-center justify-center z-50">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-lg shadow-2xl relative animate__animated animate__fadeInUp m-4">
        <button onclick="cerrarModalEmisor()" class="absolute top-5 right-5 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
        
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-[#2D1B4B] text-2xl">
                <i class="fas fa-building"></i>
            </div>
            <h3 class="text-xl font-black text-[#2D1B4B]">Datos Fiscales del Despacho</h3>
            <p class="text-xs text-gray-500">Estos datos aparecerán en todas tus facturas PDF.</p>
        </div>
        
        <form action="{% url 'guardar_datos_emisor' %}" method="POST" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Razón Social</label>
                <input type="text" name="razon_social" value="{{ emisor.razon_social }}" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border border-gray-100 focus:border-[#A855F7] outline-none" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">RFC Emisor</label>
                    <input type="text" name="rfc" value="{{ emisor.rfc }}" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border border-gray-100 focus:border-[#A855F7] outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">C.P. Expedición</label>
                    <input type="text" name="codigo_postal" value="{{ emisor.codigo_postal }}" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border border-gray-100 focus:border-[#A855F7] outline-none" required>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Régimen Fiscal (Clave)</label>
                <input type="text" name="regimen_fiscal" value="{{ emisor.regimen_fiscal }}" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border border-gray-100 focus:border-[#A855F7] outline-none">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Dirección Completa (Opcional)</label>
                <input type="text" name="direccion" value="{{ emisor.direccion }}" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] border border-gray-100 focus:border-[#A855F7] outline-none">
            </div>
            
            <button type="submit" class="w-full bg-[#2D1B4B] text-white py-4 rounded-xl font-bold shadow-lg hover:bg-[#A855F7] transition-all transform hover:-translate-y-1 mt-4">
                GUARDAR CONFIGURACIÓN
            </button>
        </form>
    </div>
</div>

<script>
    function abrirModalEmisor() {
        const m = document.getElementById('modal-emisor');
        m.classList.remove('hidden');
        m.classList.add('flex');
    }
    function cerrarModalEmisor() {
        const m = document.getElementById('modal-emisor');
        m.classList.add('hidden');
        m.classList.remove('flex');
    }
</script>
{% endblock %}