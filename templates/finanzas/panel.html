{% extends 'base.html' %}
{% block content %}
<div class="max-w-7xl mx-auto animate__animated animate__fadeIn">
    
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-black text-[#1A2238]">Finanzas y Cobranza</h2>
        <div class="text-right">
            <p class="text-xs font-bold text-gray-400 uppercase">Total por Cobrar</p>
            <p class="text-2xl font-black text-red-500">${{ total_por_cobrar|floatformat:2 }}</p>
        </div>
    </div>

    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-xs text-gray-400 uppercase">
                    <tr>
                        <th class="p-6 font-black">Cliente / Concepto</th>
                        <th class="p-6 font-black text-center">Estado</th>
                        <th class="p-6 font-black text-right">Total</th>
                        <th class="p-6 font-black text-right">Pagado</th>
                        <th class="p-6 font-black text-right text-red-500">Saldo</th>
                        <th class="p-6 font-black text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    {% for c in cuentas %}
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                        <td class="p-6">
                            <p class="font-bold text-[#1A2238]">{{ c.cliente.nombre_empresa }}</p>
                            <p class="text-xs text-gray-400">{{ c.concepto }}</p>
                            <p class="text-[10px] text-gray-400 mt-1">Vence: {{ c.fecha_vencimiento|default:"--/--/--" }}</p>
                        </td>
                        <td class="p-6 text-center">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase
                                {% if c.estado == 'pagado' %}bg-green-100 text-green-600
                                {% elif c.estado == 'parcial' %}bg-yellow-100 text-yellow-600
                                {% else %}bg-red-100 text-red-500{% endif %}">
                                {{ c.get_estado_display }}
                            </span>
                        </td>
                        <td class="p-6 text-right font-bold text-gray-600">${{ c.monto_total|floatformat:2 }}</td>
                        <td class="p-6 text-right font-bold text-green-600">${{ c.monto_pagado|floatformat:2 }}</td>
                        <td class="p-6 text-right font-black text-red-500">${{ c.saldo_pendiente|floatformat:2 }}</td>
                        <td class="p-6 text-center">
                            {% if c.estado != 'pagado' %}
                            <button onclick="abrirPago('{{ c.id }}', '{{ c.cliente.nombre_empresa }}', '{{ c.saldo_pendiente }}')" class="bg-[#1A2238] text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-[#2C3E50] shadow-md transition-all">
                                <i class="fas fa-hand-holding-usd mr-1"></i> PAGAR
                            </button>
                            {% else %}
                            <span class="text-green-500 font-bold text-xs"><i class="fas fa-check-circle"></i> Al corriente</span>
                            {% endif %}
                            
                            {% if c.pagos.exists %}
                            <div class="mt-2 space-y-1">
                                {% for p in c.pagos.all %}
                                <a href="{% url 'recibo_pago_pdf' p.id %}" target="_blank" class="block text-[10px] text-blue-500 hover:underline">
                                    Recibo ${{ p.monto|floatformat:0 }} ({{ p.fecha_pago|date:"d/m" }})
                                </a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="p-10 text-center text-gray-400">No hay cuentas por cobrar registradas.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modal-pago" class="fixed inset-0 bg-[#1A2238]/90 hidden items-center justify-center z-50 backdrop-blur-sm animate__animated animate__fadeIn">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-md m-4 shadow-2xl relative animate__animated animate__zoomIn">
        <button onclick="document.getElementById('modal-pago').classList.add('hidden')" class="absolute top-6 right-6 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
        
        <h3 class="text-xl font-black text-[#1A2238] mb-1">Registrar Pago</h3>
        <p class="text-sm text-gray-400 mb-6">Cliente: <span id="pago-cliente" class="font-bold text-[#C0A062]"></span></p>
        
        <form action="{% url 'registrar_pago' %}" method="POST" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="cuenta_id" id="input-cuenta-id">
            
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1">Monto a Pagar (Máx: $<span id="max-saldo"></span>)</label>
                <input type="number" name="monto" id="input-monto" step="0.01" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#1A2238] text-lg border-2 border-transparent focus:border-[#C0A062] outline-none" required>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1">Método de Pago</label>
                <select name="metodo" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#1A2238] border-none outline-none">
                    <option value="transferencia">Transferencia Electrónica</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 mb-1">Referencia / Folio</label>
                <input type="text" name="referencia" placeholder="Ej. SPEI-12345" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#1A2238] text-sm border-none outline-none">
            </div>

            <button type="submit" class="w-full bg-[#1A2238] text-white py-4 rounded-xl font-black shadow-lg hover:bg-[#2C3E50] mt-2">
                CONFIRMAR PAGO
            </button>
        </form>
    </div>
</div>

<script>
    function abrirPago(id, cliente, saldo) {
        document.getElementById('input-cuenta-id').value = id;
        document.getElementById('pago-cliente').innerText = cliente;
        document.getElementById('max-saldo').innerText = saldo;
        document.getElementById('input-monto').max = saldo;
        document.getElementById('input-monto').value = saldo; // Sugerir pago total
        
        const modal = document.getElementById('modal-pago');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
</script>
{% endblock %}