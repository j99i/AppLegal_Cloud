{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="max-w-7xl mx-auto animate__animated animate__fadeIn">
    
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-3xl font-black text-[#2D1B4B]">Finanzas y Cobranza</h2>
            <p class="text-sm text-gray-400">Gestiona los ingresos y emite órdenes de cobro.</p>
        </div>
        <div class="text-right bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-xs font-bold text-gray-400 uppercase">Total por Cobrar</p>
            <p class="text-2xl font-black text-red-500">${{ total_por_cobrar|floatformat:2|intcomma }}</p>
        </div>
    </div>

    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-xs text-gray-400 uppercase">
                    <tr>
                        <th class="p-6 font-black text-[#2D1B4B]">Cliente / Concepto</th>
                        <th class="p-6 font-black text-center text-[#2D1B4B]">Estado</th>
                        <th class="p-6 font-black text-right text-[#2D1B4B]">Total</th>
                        <th class="p-6 font-black text-right text-[#2D1B4B]">Pagado</th>
                        <th class="p-6 font-black text-right text-red-500">Saldo</th>
                        <th class="p-6 font-black text-center text-[#2D1B4B] w-64">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    {% for c in cuentas %}
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                        <td class="p-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-[#2D1B4B] font-bold text-xs">
                                    {{ c.cliente.nombre_empresa|slice:":2"|upper }}
                                </div>
                                <div>
                                    <p class="font-bold text-[#2D1B4B]">{{ c.cliente.nombre_empresa }}</p>
                                    <p class="text-xs text-gray-400">{{ c.concepto }}</p>
                                    {% if c.fecha_vencimiento %}
                                    <p class="text-[10px] text-gray-400 mt-1">
                                        <i class="far fa-clock mr-1"></i>Vence: {{ c.fecha_vencimiento|date:"d/m/Y" }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <td class="p-6 text-center">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider
                                {% if c.estado == 'pagado' %}bg-green-100 text-green-600
                                {% elif c.estado == 'parcial' %}bg-yellow-100 text-yellow-600
                                {% else %}bg-red-100 text-red-500{% endif %}">
                                {{ c.get_estado_display }}
                            </span>
                        </td>

                        <td class="p-6 text-right font-bold text-gray-600">${{ c.monto_total|floatformat:2|intcomma }}</td>
                        <td class="p-6 text-right font-bold text-green-600">${{ c.monto_pagado|floatformat:2|intcomma }}</td>
                        <td class="p-6 text-right font-black text-red-500">${{ c.saldo_pendiente|floatformat:2|intcomma }}</td>

                        <td class="p-6 text-center">
                            <div class="flex flex-col gap-3">
                                
                                <div class="flex justify-center gap-2">
                                    <button onclick="abrirModalCobro('{{ c.id }}', 'anticipo')" 
                                       class="flex-1 bg-purple-50 text-[#2D1B4B] hover:bg-[#2D1B4B] hover:text-white px-2 py-1.5 rounded-lg text-[10px] font-bold transition-all text-center border border-purple-100 flex items-center justify-center"
                                       title="Generar Orden del 50%">
                                        <i class="fas fa-percentage mr-1"></i> 50%
                                    </button>
                                    
                                    <button onclick="abrirModalCobro('{{ c.id }}', 'liquidacion')" 
                                       class="flex-1 bg-purple-50 text-[#2D1B4B] hover:bg-green-500 hover:text-white px-2 py-1.5 rounded-lg text-[10px] font-bold transition-all text-center border border-purple-100 flex items-center justify-center"
                                       title="Generar Liquidación">
                                        <i class="fas fa-file-invoice-dollar mr-1"></i> Fin
                                    </button>
                                </div>

                                {% if c.estado != 'pagado' %}
                                <button onclick="abrirPago('{{ c.id }}', '{{ c.cliente.nombre_empresa }}', '{{ c.saldo_pendiente }}')" 
                                        class="w-full bg-[#2D1B4B] text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-[#A855F7] shadow-md transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-hand-holding-usd"></i> Registrar Pago
                                </button>
                                {% else %}
                                <div class="w-full py-2 bg-green-50 text-green-600 rounded-lg text-xs font-bold border border-green-100">
                                    <i class="fas fa-check-circle mr-1"></i> Pagado Totalmente
                                </div>
                                {% endif %}

                                {% if c.pagos.exists %}
                                <div class="pt-2 border-t border-gray-100">
                                    <p class="text-[10px] text-left text-gray-400 font-bold mb-1 ml-1">RECIBOS DE PAGO:</p>
                                    <div class="space-y-1 max-h-24 overflow-y-auto custom-scrollbar">
                                        {% for p in c.pagos.all %}
                                        <a href="{% url 'recibo_pago_pdf' p.id %}" target="_blank" 
                                           class="flex items-center justify-between px-2 py-1 hover:bg-gray-50 rounded text-[10px] text-gray-500 group transition-colors">
                                            <span><i class="fas fa-receipt text-[#A855F7] mr-1"></i> ${{ p.monto|floatformat:0 }}</span>
                                            <span class="text-gray-300 group-hover:text-gray-500">{{ p.fecha_pago|date:"d/m" }}</span>
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="p-16 text-center">
                            <div class="flex flex-col items-center justify-center text-gray-300">
                                <i class="fas fa-folder-open text-4xl mb-3"></i>
                                <p class="font-medium">No hay cuentas por cobrar pendientes.</p>
                                <p class="text-xs">Las cotizaciones aceptadas aparecerán aquí automáticamente.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modal-orden-cobro" class="fixed inset-0 bg-[#2D1B4B]/90 hidden items-center justify-center z-50 backdrop-blur-sm animate__animated animate__fadeIn p-4">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-lg shadow-2xl relative animate__animated animate__zoomIn">
        <button onclick="cerrarModalCobro()" class="absolute top-6 right-6 text-gray-400 hover:text-red-500 transition-colors">
            <i class="fas fa-times text-xl"></i>
        </button>

        <div class="text-center mb-6">
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3 text-[#A855F7] text-xl">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <h3 class="text-xl font-black text-[#2D1B4B]">Generar Orden de Pago</h3>
            <p class="text-sm text-gray-400">Confirma los datos bancarios para el PDF.</p>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">Banco</label>
                <div class="relative">
                    <i class="fas fa-university absolute left-4 top-3.5 text-gray-300"></i>
                    <input type="text" id="cobro-banco" value="BBVA" class="w-full pl-10 pr-4 py-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-[#2D1B4B] focus:border-[#A855F7] outline-none">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">Beneficiario</label>
                    <input type="text" id="cobro-titular" value="Jovani Ortega Soriano" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-[#2D1B4B] focus:border-[#A855F7] outline-none text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">No. Cuenta</label>
                    <input type="text" id="cobro-cuenta" value="1234567890" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-[#2D1B4B] focus:border-[#A855F7] outline-none text-sm">
                </div>
            </div>

            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">CLABE Interbancaria</label>
                <div class="relative">
                    <i class="fas fa-hashtag absolute left-4 top-3.5 text-gray-300"></i>
                    <input type="text" id="cobro-clabe" value="012345678901234567" class="w-full pl-10 pr-4 py-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-[#2D1B4B] focus:border-[#A855F7] outline-none tracking-wider">
                </div>
            </div>
            
            <input type="hidden" id="cobro-cuenta-id">
            <input type="hidden" id="cobro-tipo">

            <div class="pt-4">
                <button onclick="descargarPDFCobro()" class="w-full bg-[#A855F7] text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#9333EA] transition-all flex justify-center items-center gap-2 transform hover:-translate-y-1">
                    <i class="fas fa-download"></i> DESCARGAR ORDEN PDF
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modal-pago" class="fixed inset-0 bg-[#2D1B4B]/90 hidden items-center justify-center z-50 backdrop-blur-sm animate__animated animate__fadeIn p-4">
    <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl relative animate__animated animate__zoomIn">
        <button onclick="cerrarModalPago()" class="absolute top-6 right-6 text-gray-400 hover:text-red-500 transition-colors">
            <i class="fas fa-times text-xl"></i>
        </button>
        
        <div class="mb-6">
            <h3 class="text-xl font-black text-[#2D1B4B]">Registrar Pago</h3>
            <p class="text-sm text-gray-400">Ingresa los detalles del pago recibido.</p>
        </div>

        <div class="bg-purple-50 p-4 rounded-xl mb-6 border border-purple-100">
            <p class="text-xs font-bold text-gray-400 uppercase mb-1">Cliente</p>
            <p id="pago-cliente" class="font-black text-[#2D1B4B] text-lg leading-tight"></p>
        </div>
        
        <form action="{% url 'registrar_pago' %}" method="POST" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="cuenta_id" id="input-cuenta-id">
            
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Monto Recibido</label>
                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-gray-400 font-bold">$</span>
                    <input type="number" name="monto" id="input-monto" step="0.01" 
                           class="w-full pl-8 pr-4 py-3 bg-gray-50 rounded-xl font-black text-[#2D1B4B] text-lg border-2 border-transparent focus:border-[#A855F7] outline-none transition-all placeholder-gray-300" 
                           required>
                </div>
                <p class="text-[10px] text-gray-400 text-right mt-1 mr-1">Saldo pendiente: $<span id="max-saldo"></span></p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Método</label>
                    <div class="relative">
                        <select name="metodo" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-gray-600 text-sm border-2 border-transparent focus:border-[#A855F7] outline-none appearance-none cursor-pointer">
                            <option value="transferencia">Transferencia</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="cheque">Cheque</option>
                            <option value="tarjeta">Tarjeta</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-4 text-gray-400 text-xs pointer-events-none"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">Ref / Folio</label>
                    <input type="text" name="referencia" placeholder="Ej. 1234" 
                           class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#2D1B4B] text-sm border-2 border-transparent focus:border-[#A855F7] outline-none">
                </div>
            </div>

            <div class="pt-2">
                <button type="submit" class="w-full bg-[#2D1B4B] text-white py-4 rounded-xl font-black shadow-lg hover:bg-[#A855F7] hover:shadow-xl hover:-translate-y-0.5 transition-all flex justify-center items-center gap-2">
                    <i class="fas fa-check-circle"></i> CONFIRMAR INGRESO
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- LÓGICA MODAL ORDEN DE COBRO ---
    function abrirModalCobro(cuentaId, tipo) {
        document.getElementById('cobro-cuenta-id').value = cuentaId;
        document.getElementById('cobro-tipo').value = tipo;
        const modal = document.getElementById('modal-orden-cobro');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function cerrarModalCobro() {
        const modal = document.getElementById('modal-orden-cobro');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function descargarPDFCobro() {
        const id = document.getElementById('cobro-cuenta-id').value;
        const tipo = document.getElementById('cobro-tipo').value;
        const banco = document.getElementById('cobro-banco').value;
        const titular = document.getElementById('cobro-titular').value;
        const cuenta = document.getElementById('cobro-cuenta').value;
        const clabe = document.getElementById('cobro-clabe').value;

        const urlBase = `/finanzas/cobro/${id}/${tipo}/`;
        const params = `?banco=${encodeURIComponent(banco)}&titular=${encodeURIComponent(titular)}&cuenta_num=${encodeURIComponent(cuenta)}&clabe=${encodeURIComponent(clabe)}`;
        
        window.open(urlBase + params, '_blank');
        cerrarModalCobro();
    }

    // --- LÓGICA MODAL REGISTRO PAGO ---
    function abrirPago(id, cliente, saldo) {
        // Limpiar saldo (quitar comas si las tiene)
        let saldoLimpio = saldo.toString().replace(/,/g, '');
        
        document.getElementById('input-cuenta-id').value = id;
        document.getElementById('pago-cliente').innerText = cliente;
        document.getElementById('max-saldo').innerText = saldo;
        
        const inputMonto = document.getElementById('input-monto');
        inputMonto.max = saldoLimpio;
        inputMonto.value = saldoLimpio; 
        
        const modal = document.getElementById('modal-pago');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function cerrarModalPago() {
        const modal = document.getElementById('modal-pago');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
</script>
{% endblock %}